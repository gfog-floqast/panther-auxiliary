# Copyright (C) 2020 Panther Labs Inc
#
# Panther Enterprise is licensed under the terms of a commercial license available from
# Panther Labs Inc ("Panther Commercial License") by contacting contact@runpanther.com.
# All use, distribution, and/or modification of this software, whether commercial or non-commercial,
# falls under the Panther Commercial License to the extent it is permitted.

AWSTemplateFormatVersion: 2010-09-09
Description: IAM role for troubleshooting Panther

Parameters:
  SupportRoleName:
    Type: String
    Description: Name of the support IAM role. If an empty string, the name will be autogenerated
    Default: PantherSupportRole
  IdentityAccountId:
    Type: String
    Description: The account ID for the account the support role will be assumed from
    Default: '255674391660'
  MaxSessionDurationSec:
    Type: Number
    Default: 14400 # 4 hours
    Description: The session duration of the assumed role.

Conditions:
  AccountSpecified: !Not [!Equals [!Ref IdentityAccountId, '']]
  RoleNameSpecified: !Not [!Equals [!Ref SupportRoleName, '']]

Resources:
  SupportRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !If [RoleNameSpecified, !Ref SupportRoleName, !Ref AWS::NoValue]
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !If
                - AccountSpecified
                - !Sub arn:${AWS::Partition}:iam::${IdentityAccountId}:root
                - !Sub arn:${AWS::Partition}:iam::${AWS::AccountId}:root
            Action: sts:AssumeRole
            Condition:
              Bool:
                aws:MultiFactorAuthPresent: true
                aws:SecureTransport: true
              NumericLessThan:
                aws:MultiFactorAuthAge: !Ref MaxSessionDurationSec
      Description: IAM role for troubleshooting Panther
      Tags:
        - Key: Application
          Value: Panther
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AWSCloudFormationReadOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchReadOnlyAccess
        - arn:aws:iam::aws:policy/IAMReadOnlyAccess

  SupportPolicy:
    Type: AWS::IAM::Policy
    Properties:
      PolicyName: PantherSupport
      Roles:
        - !Ref SupportRole
      PolicyDocument:
        # 'mage fmt' will copy this policy document into ../terraform/panther_support_role/main.tf
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              # check acm configurations
              - acm:ListCertificates
              - acm:DescribeCertificate
              # View billing information
              - ce:GetCostAndUsage
              - ce:GetDimensionValues
              # Check dynamo configurations
              - dynamodb:ListTables
              - dynamodb:DescribeLimits
              - dynamodb:DescribeTable
              - dynamodb:DescribeTimeToLive
              # Check ecr configurations
              - ecr:DescribeImages
              - ecr:DescribeRepositories
              # Check ecs configurations
              - ecs:DescribeClusters
              - ecs:DescribeContainerInstances
              - ecs:DescribeServices
              - ecs:DescribeTaskDefinition
              - ecs:DescribeTaskSets
              - ecs:DescribeTasks
              - ecs:ListAccountSettings
              - ecs:ListAttributes
              - ecs:ListClusters
              - ecs:ListContainerInstances
              - ecs:ListServices
              - ecs:ListTaskDefinitions
              - ecs:ListTasks
              - elasticfilesystem:DescribeFileSystems
              # Check load balancer configurations
              - elasticloadbalancing:DescribeLoadBalancers
              # Check firehose configurations
              - firehose:DescribeDeliveryStream
              - firehose:List*
              # Check glue configurations
              - glue:BatchGet*
              - glue:Get*
              # Personal Health Dashboard (service outages)
              - health:*
              # Check lambda configurations
              - events:Describe*
              - events:List*
              - lambda:GetAccountSettings
              - lambda:GetAlias
              - lambda:GetFunction
              - lambda:GetFunctionConcurrency
              - lambda:GetFunctionConfiguration
              - lambda:GetFunctionEventInvokeConfig
              - lambda:GetLayerVersion
              - lambda:GetLayerVersionByArn
              - lambda:GetLayerVersionPolicy
              - lambda:GetPolicy
              - lambda:ListAliases
              - lambda:ListEventSourceMappings
              - lambda:ListFunctions
              - lambda:ListLayerVersions
              - lambda:ListLayers
              - lambda:ListTags
              - tag:GetResources
              # Check s3 configurations
              - s3:GetBucketAcl
              - s3:GetBucketCORS
              - s3:GetBucketLocation
              - s3:GetBucketNotification
              - s3:GetBucketObjectLockConfiguration
              - s3:GetBucketPolicy
              - s3:ListAllMyBuckets
              # Check sqs configurations
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
              - sqs:ListDeadLetterSourceQueues
              - sqs:ListQueues
              # sqs troubleshooting
              - sqs:PurgeQueue
              # AWS support
              - support:*
              # Check step function / state machine configurations
              - states:Describe*
              - states:GetExecutionHistory
              - states:List*
            Resource: '*'

Outputs:
  SupportRoleArn:
    Value: !GetAtt SupportRole.Arn
